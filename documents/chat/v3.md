# Banddy 채팅 가이드 v3

v3 변경 핵심
- 전역 1회 연결: `AuthProvider`에서 토큰 복원 직후 `webSocketService.connect()` 실행. 홈 등에서 중복 connect 제거
- 토큰 준비 후 connect: `useWebSocket`은 `authStore.accessToken`이 있을 때만 자동 연결 시도
- 구독 타이밍 분리: `isConnected === true` 이후에 `/user/queue/unread` 구독 시작
- 비활성 재연결: STOMP 클라이언트가 inactive면 `connect()`에서 `initClient()`로 재초기화 후 `activate()`
- 라우팅 기반 입장: `ChatPage`는 쿼리 파라미터(`roomId`,`roomType`,`receiverId?`)만 있으면 REST+WS 자동 처리
- 방 이탈 처리: 뒤로가기/언마운트/나가기 시 `exitChatRoom()`로 구독 해제
- 환경변수 기반 WS URL: `VITE_API_BASE_URL + '/ws'` (예: `https://banddy.site`)

## 목적지(DESTINATION)
- 구독
  - 그룹: `/topic/room/{roomId}`
  - 개인: `/user/queue/room/{roomId}`
  - 안읽음: `/user/queue/unread`
- 전송
  - 그룹: `/app/chat/group.sendMessage/{roomId}`
  - 개인: `/app/chat/private.sendMessage/{roomId}` (body에 `receiverId` 필수)

## CONNECT 헤더
```json
{
  "accept-version": "1.1,1.0",
  "heart-beat": "10000,10000",
  "Authorization": "<accessToken>"
}
```
- REST는 `Bearer <token>`, STOMP는 토큰 문자열 그대로 사용

## 라우팅 사용 예
- 그룹: `/home/chat?roomId=42&roomType=GROUP`
- 개인: `/home/chat?roomId=43&roomType=PRIVATE&receiverId=5`

## 클라이언트 매핑
- `src/constants/index.ts`
  - `WEBSOCKET.SEND_MESSAGE_GROUP/PRIVATE`
  - `WEBSOCKET.SUBSCRIBE_GROUP/PRIVATE/UNREAD`
- `src/services/WebSocketService.ts`
  - inactive 재초기화 + `activate()`
  - CONNECT 헤더에 Authorization(trim)
- `src/pages/chat/hooks/useWebSocket.ts`
  - 토큰 있을 때만 connect, `isConnected` 후 unread 구독
- `src/shared/components/AuthProvider.tsx`
  - 토큰 복원 직후 전역 1회 connect
- `src/pages/chat/ChatPage.tsx`
  - 뒤로가기/언마운트/나가기 시 `exitChatRoom()` 호출

## 메시지 바디 예시
- GROUP
```json
{ "content": "안녕하세요!", "roomType": "GROUP" }
```
- PRIVATE
```json
{ "content": "안녕하세요!", "roomType": "PRIVATE", "receiverId": 5 }
```

## 빠른 시작 체크리스트
1) `.env` 설정: `VITE_API_BASE_URL=https://banddy.site`
2) 로그인 → 홈 진입
3) Network에 `/ws/info` 이후 `/ws/{server-id}/{session-id}/websocket`(101) 또는 `/xhr_streaming`(200 pending) 확인
4) 채팅 페이지로 이동(위 라우팅) → 전송/수신 확인

## 트러블슈팅
- `/ws/info`만 뜨고 세션이 안 뜸: 중복 connect/즉시 disconnect 여부 확인(전역 1회만 connect), StrictMode 영향 점검
- STOMP Debug에 `inactive`: `connect()`에서 재초기화되도록 수정됨. 새로고침 후 재시도
- 개인 전송 실패: `roomType=PRIVATE`, `receiverId` 누락 여부 확인
- CORS/HTTPS: 로컬에서도 SockJS는 `https://banddy.site/ws`로 접속 (문제 없음)
